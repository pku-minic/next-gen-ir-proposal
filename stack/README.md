# 基于栈的 IR

我们暂且把这种 IR 叫做 S2.

S2 的设计参考了 [MiniVM](https://github.com/pku-minic/MiniVM) 内部所使用的 [Gopher](https://github.com/pku-minic/MiniVM/blob/master/src/vm/README.md).

## 指令格式

S2 IR 的指令由两个字段组成, 分别为**操作** (`op`) 和**操作数** (`opr`).

前者用来编码 IR 的操作, 后者用来编码这条指令所需要的其他必要的信息, 但未必是真的 “操作数”. 因为 S2 是一种基于栈的 IR, 大部分操作的操作数都来自于栈顶.

## 抽象机器

S2 IR 的语义和执行机制基于一种抽象机器, 该机器需要具备:

* **程序计数器**: 存储当前正在执行的指令的地址, 用于指导指令的获取.
* **操作数栈**: 存储 S2 IR 的操作数.
* **局部变量栈**: 存储函数的局部变量.
* **全局内存**: 存储全局变量.

## 符号名称

同 [IR2 提案](/llvm-like#符号名称). 符号名称只能被用来标记全局变量, 函数名称或标号.

## 局部变量/数组声明

TODO

## 全局变量/数组声明

TODO

## 注释和注解

同 [IR2 提案](/llvm-like#注释和注解). 支持的标准注解:

| 名称    | 值      | 含义                              |
| --      | --      | --                                |
| name    | 符号名  | 标记局部变量所对应的符号名称      |
| src     | 文件名  | 标记 IR 文件对应的源代码文件      |
| line    | 行号    | 标记 IR 对应的源代码文件的行数    |
| version | 版本号  | 标记 IR 文件对应的 IR 标准的版本  |

## TODO

咕了.

咕之前放一个 TODO 是一种美德.
